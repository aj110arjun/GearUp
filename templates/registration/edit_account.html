{% extends 'registration/base.html' %}
{% load static %}

{% block title %}Edit Profile - GearUp{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white">
          <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i> Edit Profile</h4>
        </div>

        <div class="card-body p-4">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Profile Image with Click to Change -->
            <div class="text-center mb-4 position-relative">
              <img id="profilePreview" 
                   src="{{ user.accountinfo.profile.url }}" 
                   class="rounded-circle img-thumbnail mb-2" 
                   style="width: 120px; height: 120px; object-fit: cover; cursor: pointer;" 
                   alt="Profile Image"
                   title="Click to change image">

              <!-- Hidden File Input -->
              <input type="file" name="profile" id="id_profile" class="d-none" accept="image/*">

              <p class="small text-muted mt-2">Click the image to change your profile picture</p>
            </div>

            <hr>

            <!-- User Fields -->
            {% for field in u_form %}
              <div class="mb-3">
                <label class="form-label">{{ field.label }}</label>
                {{ field }}
              </div>
            {% endfor %}

            <!-- Other Profile Fields (except image) -->
            {% for field in p_form %}
              {% if field.name != 'profile' %}
                <div class="mb-3">
                  <label class="form-label">{{ field.label }}</label>
                  {{ field }}
                </div>
              {% endif %}
            {% endfor %}

            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'account' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Cancel
              </a>
              <button type="submit" class="btn btn-dark">
                <i class="bi bi-save me-1"></i> Update Profile
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript for Click-to-Upload & Preview -->
<script>
  const profilePreview = document.getElementById('profilePreview');
  const profileInput = document.getElementById('id_profile');

  // Click image to open file dialog
  profilePreview.addEventListener('click', () => profileInput.click());

  // Live preview when file selected
  profileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
              profilePreview.src = e.target.result;
          }
          reader.readAsDataURL(file);
      }
  });
</script>
{% endblock %}
